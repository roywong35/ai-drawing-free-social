<div class="max-w-2xl mx-auto bg-white" #postContainer>
  <!-- Loading State -->
  <div *ngIf="loading" class="flex justify-center items-center p-8">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="p-4 text-red-500 text-center">
    {{ error }}
  </div>

  <!-- Post Content -->
  <div *ngIf="!loading && !error && post">
    <!-- Back Button -->
    <div class="border-b p-4">
      <button (click)="goBack()" class="text-gray-500 hover:text-gray-700 flex items-center">
        <i class="fas fa-arrow-left mr-2"></i>
        Back
      </button>
    </div>

    <!-- Parent Chain (shown when viewing a reply) -->
    <div *ngIf="post.post_type === 'reply'" class="relative">
      <!-- Parent Posts from Chain -->
      <ng-container *ngFor="let parentPost of parentChain; let i = index">
        <div class="relative">
          <!-- Connecting Line -->
          <div class="absolute left-[31px] w-0.5 bg-gray-200 z-[5]"
               [style]="i === 0 ? 'top: 45px; height: calc(100% - 45px);' : 'top: 0; height: 100%;'">
          </div>
          
          <app-post 
            [post]="parentPost"
            [isDetailView]="true"
            [isConnectedToParent]="true"
            class="relative">
          </app-post>
        </div>
      </ng-container>
    </div>

    <!-- Main Post -->
    <div class="relative" #mainPost>
      <!-- Thread Line for Replies -->
      <div *ngIf="post.post_type === 'reply'" 
           class="absolute left-[31px] w-0.5 bg-gray-200 z-[5]"
           style="top: 0; height: 45px;">
      </div>
      
      <app-post 
        [post]="post" 
        [isDetailView]="true"
        [isConnectedToParent]="post.post_type === 'reply'"
        (postUpdated)="loadPost()"
        class="relative">
      </app-post>
    </div>

    <!-- Reply Input -->
    <div *ngIf="currentUser" class="border-t border-b bg-white p-3">
      <div class="flex">
        <!-- Profile picture only shown when focused -->
        <img *ngIf="replyFocused" 
             [src]="currentUser.profile_picture || defaultAvatar" 
             [alt]="currentUser.username" 
             class="w-10 h-10 rounded-full mt-8">
        <div class="flex-grow">
          <!-- Reply to text (only shown when expanded) -->
          <div *ngIf="replyFocused" class="text-gray-500 text-base mb-2 ml-2">
            Replying to <span class="text-blue-500">{{'@'}}{{post.author.handle}}</span>
          </div>

          <!-- Input area -->
          <div class="relative">
            <textarea
              #replyTextarea
              [(ngModel)]="newReply"
              (input)="onTextareaInput()"
              (focus)="replyFocused = true"
              placeholder="Post your reply"
              [class.h-10]="!replyFocused"
              class="w-full p-2 focus:outline-none resize-none text-base placeholder:text-lg"
              [rows]="replyFocused ? 2 : 1">
            </textarea>
            
            <!-- Reply button (only shown when not focused) -->
            <button
              *ngIf="!replyFocused"
              [class.opacity-50]="!newReply.trim()"
              [class.cursor-not-allowed]="!newReply.trim()"
              (click)="submitReply()"
              class="absolute bottom-2 right-2 px-4 py-1.5 bg-blue-500 text-white rounded-full hover:bg-blue-600 font-medium">
              Reply
            </button>
          </div>
          
          <!-- Bottom actions (only shown when focused) -->
          <div *ngIf="replyFocused" class="flex justify-between items-center mt-2">
            <!-- Left side: Photo and Emoji pickers -->
            <div class="flex items-center space-x-2">
              <!-- Photo picker -->
              <button
                (click)="onPhotoClick($event)"
                class="text-blue-500 hover:text-blue-600 p-1.5 rounded-full transition-colors">
                <i class="far fa-image text-[15px]"></i>
              </button>
              <!-- Emoji picker -->
              <button
                (click)="toggleEmojiPicker($event)"
                class="text-blue-500 hover:text-blue-600 p-1.5 rounded-full transition-colors">
                <i class="far fa-smile text-[15px]"></i>
              </button>
            </div>

            <!-- Right side: Reply button -->
            <button
              [class.opacity-50]="!newReply.trim()"
              [class.cursor-not-allowed]="!newReply.trim()"
              (click)="submitReply()"
              class="px-4 py-1.5 bg-blue-500 text-white rounded-full hover:bg-blue-600 font-medium">
              Reply
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Replies -->
    <div *ngIf="replies.length > 0">
      <div *ngFor="let reply of replies; let i = index" class="relative">
        <app-post 
          [post]="reply" 
          [showFullHeader]="true"
          [isReply]="true"
          [isConnectedToParent]="false"
          (postUpdated)="loadPost()"
          class="border-b">
        </app-post>
      </div>
    </div>

    <!-- No Replies Message -->
    <div *ngIf="!loading && replies.length === 0" class="p-4 text-center text-gray-500">
      No replies yet. Be the first to reply!
    </div>
  </div>
</div> 